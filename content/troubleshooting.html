---
title: Troubleshooting
---

<p>
Troubleshooting a running firewall is relatively simple and for almost all
iptables firewalls the means you have are the same:
<span class="important">the system log</span>.
</p>

<p>
The system log (usually at <span class="filename">/var/log/messages</span>)
will log all the packets dropped <span class="important">implicitly</span>
by FireHOL. <span class="important">Implicitly</span> means all packets
that did not match any of the rules in FireHOL's configuration file.
</p>

<p>
FireHOL always logs all packets not matched by any rule, although it does
not log every single packet, in order to protect you from an attack
that could "eat" all of your free hard disk space.
</p>

<p>
The frequency packets are logged is controlled by the same means the
optional rule parameter <%= fh_manref('rule-params','loglimit') %>
is controlled.
</p>

<p>
In the system log you will find entries that look like:
</p>
<pre class="programoutput">
Dec 21 20:01:07 gateway kernel: IN-internet:IN=ppp0 OUT= MAC= \
  SRC=200.75.88.187 DST=195.97.5.193 LEN=78 TOS=0x00 PREC=0x00 \
  TTL=111 ID=63816 PROTO=UDP SPT=34165 DPT=137 LEN=58 

Dec 21 22:25:39 gateway kernel: OUT-unknown:IN= OUT=ppp0 \
  SRC=195.97.5.193 DST=192.168.23.1 LEN=48 TOS=0x00 PREC=0x00 \
  TTL=64 ID=0 DF PROTO=TCP SPT=139 DPT=1255 WINDOW=2128 \
  RES=0x00 ACK SYN URGP=0 
  
Dec 21 20:01:07 gateway kernel: PASS-unknown:IN=ppp0 OUT=eth0 \
  SRC=200.75.88.187 DST=195.97.5.194 LEN=78 TOS=0x00 PREC=0x00 \
  TTL=110 ID=64840 PROTO=UDP SPT=34132 DPT=137 LEN=58 
</pre>

<p>
Each of such lines represent one packet that did not satisfy the
requirements of the configuration file rules.
</p>

<p>
The important things to look in these logs are:
</p>

<ul>
  <li><span class="li-header">Its reason text</span>.
    In FireHOL this has the form <span class="important">IN-name</span>,
    <span class="important">OUT-name</span>,
    <span class="important">PASS-name</span>.
    <ul>
      <li><span class="li-header">IN-name</span> matches packets that
          dropped at the end of the interface's
          <span class="important">name</span> input.
          These are packets tried to come into this host (it is not
          routed traffic).
          <br/>
          <span class="important">Name</span> matches the name given to
          a FireHOL <%= fh_manref('def-interface','interface') %>
          There is also the special name
          <span class="important">unknown</span> that matches packets
          tried to come into this host but did not match any of
          the <%= fh_manref('def-interface','interfaces') %>
          given in FireHOL's configuration file.
      </li>
  
      <li><span class="important">OUT-name</span> matches packets that
          dropped at the end of the interface's
          <span class="important">name</span> output.
          These are packets the host tried to send (it is not traffic
          routed).
          <br/>
          <span class="important">Name</span> matches the name given to
          a FireHOL <%= fh_manref('def-interface','interface') %>
          There is also the special name
          <span class="important">unknown</span> that matches packets
          that tried to go out of this host but did not match any of
          the <%= fh_manref('def-interface','interfaces') %>
          given in FireHOL's configuration file.
      </li>
  
      <li><span class="important">PASS-unknown</span> matches packets
           that dropped at the end of all
           <%= fh_manref('def-router','routers') %>
           This matches forwarded traffic.
           <br/>
           There is no <span class="important">name</span> here, since
           all FireHOL <%= fh_manref('def-router','routers') %>
           have only one <%= fh_manref('cmd-policy','policy') %>
           <span class="important">RETURN</span>.
           This makes all packets traverse all routers and then get
           dropped at the end of the firewall.
      </li>
    </ul>
  </li>
  
  <li><span class="li-header">IN=</span> gives the real network interface
       name the packet came in from.
       <br/>
       It can be empty when the packet was generated locally.
  </li>
  
  <li><span class="li-header">OUT=</span> gives the real network interface
       name the packet tried to use to go out of this host.
       <br/>
       It can be empty when the packet was to be received by the firewall
       host.
  </li>
  
  <li><span class="li-header">SRC=</span> gives the IP address of the sender.
  </li>

  <li><span class="li-header">DST=</span> gives the IP address of the
       packet's destination.
  </li>

  <li><span class="li-header">PROTO=</span> gives the protocol this packet
      is using (TCP, UDP, ICMP, etc).
  </li>

  <li><span class="li-header">SPT=</span> gives the source port number
      of this packet.
  </li>

  <li><span class="li-header">DPT=</span> gives the destination port
      number of this packet.
  </li>
</ul>

<p>
Generally, you should monitor the system log for such entries and decide
if each entry was something useful or not.  If it was something useful,
you should have added another service somewhere in your FireHOL
configuration to match that packet and allow it to reach its destination.
If it was not something useful, then FireHOL did the right job
and dropped it.
</p>

<p>
Keep in mind that there are certain cases where packets get dropped even
though FireHOL has specific rules that should allow them to pass. Such
cases are not always errors, and here is why:
</p>

<p>
The iptables connection tracker has a mechanism for matching request
packets and reply packets.  When an allowed request comes in, the
connection tracker keeps it in a list and then waits for a matching reply to
come in the opposite direction. This list of
<span class="important">active connections</span> is available for you
to see at <span class="filename">/proc/net/ip_conntrack</span>.
Simply <span class="command">cat</span> this file to see all the current
connections your system has.
</p>

<p>
The connection tracker will wait for a reply a certain amount of time.
This time is, for example, about 20 seconds for UDP traffic.
After that time the connection tracker will remove the request from its list.
A reply that is send after the connection tracker has removed the request
from its list, will be dropped and therefore logged in
the system log.
</p>

<p>
This situation may, for example, produce a few log entries in your DNS
server for cases where the DNS server could not respond
within the time limits set by iptables, but this is not a problem
because the DNS client had already timed out in 2 or 3 seconds.
</p>

<p>
Note however that the above are common when the connection tracker is
trying to keep a state on a stateless protocol (such as UDP or ICMP).
Stateful protocols, such as TCP, always respond immediately to acknowledge
the connection and therefore the time needed by the application server
to respond does not make the connection tracker to remove the request
from its list.
</p>
